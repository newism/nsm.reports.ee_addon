<h2>Requirements</h2> 
<p>Technical requirements include:</p> 
<ul> 
	<li><a href="http://expressionengine.com">ExpressionEngine 2</a></li> 
	<li><a href="/nsm-morphine-cp-theme">Morphine CP theme addon</a></li> 
	<li><a href="http://php.net">PHP 5.2+</a></li> 
	<li>A modern browser: <a href="http://firefox.com">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a>, <a href="http://www.google.com/chrome/">Google Chrome</a> or IE8+</li> 
</ul> 
 
<h2>Installation</h2> 
<ol> 
	<li><a href="#download">Download</a> the latest version of NSM Reports.</li> 
	<li>Extract the .zip file to your desktop</li> 
	<li>Copy <code class="folder-path">system/expressionengine/third_party/nsm_reports</code> to <code class="folder-path">system/expressionengine/third_party</code></li> 
	<li>Copy <code class="folder-path">themes/third_party/nsm_reports</code> to <code class="folder-path">themes/third_party</code> (you may need to create the <code class="folder-path">third_party</code> folder)</li> 
	<li>Install <a href="/nsm-morphine-cp-theme">Morphine CP theme addon</a></li> 
</ol> 
<h3>Sample reports</h3> 
<p>The download includes sample reports to get you started. The following reports have been bundled with NSM Reports:</p> 
<ul>
	<li>...</li>
</ul>
<h3>Adding reports</h3>
<ol> 
	<li>Copy reports to the correct reports directory.</li> 
</ol>

<h2>Activation</h2> 
<ol> 
	<li>Log into your control panel</li> 
	<li>Browse to <code><a href="http://expressionengine.com/user_guide/cp/add-ons/extension_manager.html">Addons &rarr; Extensions</a></code></li> 
	<li>Enable all the NSM Reports components</li> 
	<li><a href="#toc-configuration">Configure</a> the extension settings</li> 
</ol> 
 
<h2 id="configuration">Configuration</h2> 
 
<h3 id="configuration.extension-settings">Extension settings</h3> 
 
<h4 id="configuration.extension-settings.general-settings">General settings</h4> 
<p>The following options are shown for the general settings:</p> 
<dl> 
	<dt>Report path</dt> 
	<dd>The directory that reports will be located in. If this is blank then NSM Reports will use <code class="folder-path">system/expressionengine/third_party/nsm_reports/reports</code> as the default fallback location.</dd>
</dl> 
 
<h4 id="configuration.extension-settings.download-configuration">Download configuration</h4> 
<p>These options control the report download permissions for your website. Member groups specified here are granted permission to download generated reports if they are successfully logged in. The following options are shown for the download configuration:</p> 
<dl> 
	<dt>Generated reports path</dt> 
	<dd>This is the server path that will be used to store generated reports. 
		Reports that are generated by NSM Reports are saved in this location and a download link is sent to the report's recipient email address. 
		It is mandatory that this directory has sufficient read/write permissions assigned to it. 
		We suggest that this directory should be outside of the public website directory for security.</dd>
	<dt>Download permissions</dt> 
	<dd>The member groups that have been checked in this part of the form are granted permission to download generated reports hen they have logged in. It is strongly recommended not to allow <strong>guests</strong> or <strong>members</strong> to download reports as this can create a serious security vulnerability.</dd>
</dl> 


<h1>NSM Report Class</h1>

<p>The <dfn>Nsm_report_base</dfn> class is the starting point for any report as it is the class that all reports will extend.</p>

<p>It provides the mandatory variables and methods that define a report.</p>


<h2>Define your report</h2>

<p>There are a series of protected class variables that need to be set so that users can identify your reports in the Control Panel.</p>
<ul>
<li>
<var>$title</var> - is the name of the report as it will appear to the user.
</li>
<li>
<var>$notes</var> - should contain a short description of what the report does.
</li>
<li>
<var>$author</var> - is the name and/or company of the developer that built the report.
</li>
<li>
<var>$docs_url</var> - can be a hyperlink to the online reports documentation that users can view.
</li>
<li>
<var>$version</var> - is a good place to store the revision number of your report.
</li>
<li>
<var>$type</var> - tells NSM Reports what level of complexity the report should be.
</li>
<li>
<var>$output_types</var> - list the report's allowed generated report formats.
</li>
<li>
<var>$config</var> - is used as the default report configuration when generating a report. The helps preventing errors by specifying the default values first.
</li>
</ul>

<p>The other public variables are set later in the report's runtime and no not need to be altered.</p>

<code><pre>
protected $title = 'DEMO: Report name';
protected $notes = 'A short description of what the report does.';
protected $author = 'Name and/or company of the report developer';
protected $docs_url = 'http://www.newism.com.au';
protected $version = '1.2.3';
protected $type = 'complex';
public $output_types = array(
	'browser' => 'View in browser',
	'csv' => 'Comma-Seperated Values (CSV)',
	'tab' => 'Tab-Seperated Values (TSV)',
	'html' => 'HyperText Markup Language (HTML)',
	'xml' => 'eXtensible Markup Language (XML)'
);
protected $config = array(
	'_output' => 'browser',
	'channel_filter' => false,
	'status_filter' => false
);
</pre></code>

<h2>Extending the report</h2>

<p>It is important to always start your constructor method with <dfn>parent::__construct()</dfn> to ensure that the report is initialised the intended way.</p>

<code><pre>
public function __construct(){
	parent::__construct();
}
</pre></code>


<h3>A simple example</h3>

<p>A very basic report will extend the <dfn>Nsm_report_base</dfn> class and override the <dfn>generateResults()</dfn> method to assemble a different SQL statement and return the data results as an array.</p>

<code><pre>
public function generateResults()
{
	$sql = "SELECT
		`p`.`entry_id` AS `ID`,
		`p`.`title` AS `Title`,
		`p`.`url_title` AS `URL Title`,
		`c`.`channel_title` AS `Channel Name`
	FROM `exp_channel_titles` AS `p`
	LEFT JOIN `exp_channels` AS `c`
		ON `c`.`channel_id` = `p`.`channel_id`
	ORDER BY `p`.`channel_id`";
	
	$sql = $this->sanitiseSQL($sql);
	$this->sql = $sql;
	$this->EE->db->db_debug = false;
	$query = $this->EE->db->query($this->sql);
	if ($query == false){
		return false;
	}
	return $query->result_array();
}
</pre></code>


<h3>Complex report extensions</h3>

<h4>Generating your SQL</h4>

<p>A more complex report will use user-input data collected on the report configuration form to build a SQL statement and return an array of data results.</p>

<code><pre>
public function generateResults()
{
	$config = $this->config;
	
	$channel_cond = ($config['channel_filter'])
		? " AND `t`.`channel_id` = '".intval($config['channel_filter'])."'"
		: false;
	$status_cond = ($config['status_filter'])
		? " AND `t`.`status` = '".$config['status_filter']."'"
		: false;
	
	$sql = "SELECT
		`t`.`entry_id` AS `id`,
		`t`.`title` AS `name`,
		`t`.`entry_date` AS `created_at`,
		`t`.`url_title` AS `url_title`,
		`t`.`status` AS `status`,
		`t`.`channel_id` AS `channel_id`,
		`c`.`channel_title` AS `channel_name`
	FROM `exp_channel_titles` AS `t`
	LEFT JOIN `exp_channels` AS `c`
		ON `c`.`channel_id` = `t`.`channel_id`
	WHERE `t`.`channel_id` > 0 "
	. $channel_cond . $status_cond .
	"
	ORDER BY `t`.`channel_id`,
		`t`.`title`";
	
	$sql = $this->sanitiseSQL($sql);
	$this->sql = $sql;
	$this->EE->db->db_debug = false;
	$query = $this->EE->db->query($this->sql);
	if ($query == false){
		return false;
	}
	return $query->result_array();
}
</pre></code>

<h4>Capturing user input</h4>

<p>The power of a complex report comes from this ability to define a configuration form to capture user input in order to generate different report data. It is recommended that you use the <dfn>configHTML()</dfn> method in the example class <dfn>Channels_complex_report</dfn> as a starting point and live example of collecting existing data and passing the information to the <a href="http://codeigniter.com/user_guide/general/views.html">Code-Igniter View</a> loading function.</p>

<code><pre>
public function configHTML()
{
	$channels = $this->EE->db->query('
		SELECT 
			`exp_channels`.`channel_id`, 
			`exp_channels`.`channel_title` AS `title`
		FROM `exp_channels`
		ORDER BY `channel_title`'
	);
	$status_options = $this->EE->db->query('
		SELECT DISTINCT
			`exp_channel_titles`.`status`
		FROM `exp_channel_titles`
		ORDER BY `exp_channel_titles`.`status`'
	);
	
	return $this->EE->load->_ci_load(array(
		'_ci_vars' => array(
			'config' => $this->config,
			'channels' => $channels->result_array(),
			'status_options' => $status_options->result_array()
		),
		'_ci_path' => $this->report_path . "views/configuration.php",
		'_ci_return' => true
	));
}
</pre></code>

<p>Any information that is collected on the report configuration form is captured and assigned to the report class via the <dfn>setConfig()</dfn> method. This new user input is merged with the class's original configuration details to allow the default values to remain present until overwritten.</p>

<h4>Extending output types</h4>

<p>You can extend a report by adding new output types. Pushing a new entry to the report's <var>$output_types</var> array will provide a new option that can be chosen by the user when a report is generated. You will need to add a new method in your report to process the report data and generate the output for the new <var>$output_type</var> entry. The method needs to be named in a particular way with the prefix <dfn>output_</dfn> followed by the new output type array key.</p>

<code><pre>
public $output_types = array(
	'browser' => 'View in browser',
	'csv' => 'Comma-Seperated Values (CSV)',
	'tab' => 'Tab-Seperated Values (TSV)',
	'html' => 'HyperText Markup Language (HTML)',
	'xml' => 'eXtensible Markup Language (XML)',
	'xls' => 'Excel Spreadsheet'
);

public function output_xls($results)
{
	$xls = '"ID","Title","Date Created","Status","Channel"';
	foreach($results as $row_i => $row){
		$xls .= "\n" . '"'. $row['id'] . '","' . $row['name'] . '","' . date('d/m/Y', $row['created_at']) . '","' . ucwords($row['status']) . '","' . $row['channel_name'] . '"';
	}
	return $xls;
}
</pre></code>

